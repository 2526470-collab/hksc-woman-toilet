<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥³å»æ¸…æ½”ç›£æ§ - Supabase ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #d81b60; --bg: #f4f7f6; --clear: #2e7d32; --dirty: #c62828; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; margin: 0; }
        h1 { text-align: center; color: var(--primary); }
        .floor-container { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .floor-card { background: white; padding: 15px; border-radius: 10px; border-left: 6px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .floor-name { font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .cubicle { text-align: center; }
        .label { font-size: 0.75em; color: #666; margin-bottom: 4px; }
        .btn { border: none; padding: 10px 0; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 0.85em; }
        .btn-clear { background: #e8f5e9; color: var(--clear); }
        .btn-dirty { background: #ffebee; color: var(--dirty); }
        .btn:disabled { opacity: 0.5; cursor: wait; }
    </style>
</head>
<body>

    <h1>ğŸšº å»æ‰€å³æ™‚ç‹€æ…‹åŒæ­¥</h1>
    <div class="floor-container" id="app"></div>

    <script>
        // 1. åˆå§‹åŒ– Supabase (è«‹æ›¿æ›ä¸‹æ–¹è³‡è¨Š)
        const SB_URL = 'https://jhuwrvxokixfwoqjdcii.supabase.co';
        const SB_KEY = 'sb_publishable_LwcF0ONxWLH5E1rY2p1f9g_PwqEEIrF';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        const floors = ['G', '1', '2', '3', '4', '5'];
        const app = document.getElementById('app');

        // 2. æ¸²æŸ“ UI
        floors.forEach(f => {
            const card = document.createElement('div');
            card.className = 'floor-card';
            let html = `<div class="floor-name">${f} æ¨“</div><div class="grid">`;
            for (let i = 1; i <= 5; i++) {
                const id = `${f}_${i}`;
                html += `
                    <div class="cubicle">
                        <div class="label">${i}è™Ÿ</div>
                        <button id="${id}" class="btn btn-clear" onclick="toggleStatus('${id}')">è¼‰å…¥ä¸­</button>
                    </div>`;
            }
            card.innerHTML = html + '</div>';
            app.appendChild(card);
        });

        // 3. æ›´æ–°ä»‹é¢å‡½å¼
        function updateUI(id, status) {
            const btn = document.getElementById(id);
            if (!btn) return;
            const isDirty = (status === 'dirty');
            btn.innerText = isDirty ? 'é«’æ±™' : 'ä¹¾æ·¨';
            btn.className = `btn ${isDirty ? 'btn-dirty' : 'btn-clear'}`;
            btn.disabled = false;
        }

        // 4. ä¿®æ”¹ç‹€æ…‹å‡½å¼
        async function toggleStatus(id) {
            const btn = document.getElementById(id);
            const currentStatus = (btn.innerText === 'ä¹¾æ·¨') ? 'dirty' : 'clear';
            btn.disabled = true; // é˜²æ­¢é‡è¤‡é»æ“Š
            
            await supabaseClient.from('toilet_status').upsert({ cubicle_id: id, status: currentStatus });
        }

        // 5. å¯¦æ™‚è¨‚é–±èˆ‡åˆå§‹è®€å–
        async function start() {
            // è®€å–ç›®å‰æ‰€æœ‰ç‹€æ…‹
            const { data } = await supabaseClient.from('toilet_status').select('*');
            data?.forEach(item => updateUI(item.cubicle_id, item.status));
            // å¦‚æœæ²’è³‡æ–™çš„æŒ‰éˆ•ï¼Œè¨­ç‚ºä¹¾æ·¨
            document.querySelectorAll('.btn').forEach(b => { if(b.innerText === 'è¼‰å…¥ä¸­') updateUI(b.id, 'clear'); });

            // è¨‚é–±è³‡æ–™åº«è®Šå‹•
            supabaseClient.channel('any')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'toilet_status' }, payload => {
                    updateUI(payload.new.cubicle_id, payload.new.status);
                })
                .subscribe();
        }

        start();
    </script>
</body>
</html>